---
import { Link } from './Link';
import { SearchIcon, SunIcon, MoonIcon } from './Icons';
import { Image } from 'astro:assets';
import aIcon from '../assets/A.png';

interface Props {
  class?: string;
  animateTitle?: boolean;
}

const { class: className, animateTitle = false } = Astro.props;
---
<header data-site-header class={`sticky top-0 w-full z-[1000] [&.is-menu-open]:translate-y-0 ${className || ''}`}>
  {/* Header Glass Background */}
  <div class="absolute inset-0 bg-background-primary/80 backdrop-blur-md"></div>

  <div class="relative max-w-[900px] mx-auto py-4 lg:py-6 px-4 lg:px-0">
    <nav class="flex items-center justify-between" role="navigation" aria-label="Main navigation">
      {/* Logo/Site Title */}
      <div class="flex-shrink-0">
        <Link
          href="/"
          variant="unstyled"
          className="text-text-primary font-medium text-base lg:text-lg hover:text-accent-primary transition-colors duration-200 site-title-link flex items-center gap-1.5"
          aria-label="Home"
        >
          <span class="sr-only">Alban Istrefi</span>
          <Image src={aIcon} id="site-logo-img" alt="Alban Istrefi Logo" width={64} height={64} class="w-8 h-8 object-contain brightness-0 invert [.theme-light_&]:brightness-100 [.theme-light_&]:invert-0 transition-transform duration-500 ease-in-out" format="png" quality={100} />
          <span
            aria-hidden="true"
            class={`header-title-anim ${animateTitle ? '' : 'header-title-anim--static'}`.trim()}
          >
            <span class="header-title-anim__row">
              <span class="header-title-anim__block header-title-anim__block--primary"></span>
              <span class="header-title-anim__text uppercase">
                ALBANISTREFI
                <span class="header-title-anim__dot"></span>
              </span>
            </span>
          </span>
        </Link>
      </div>

      {/* Desktop Navigation */}
      <div class="hidden lg:flex items-center justify-end">
        <div class="flex items-center space-x-6">
          <Link href="/writing" variant="navigation" class="text-[0.9375rem]">Writing</Link>
          <Link href="/about" variant="navigation" class="text-[0.9375rem]">About</Link>
        </div>
        <div class="flex items-center justify-center space-x-4 pl-4 ml-4 border-l border-border">
          <a href="/search" class="text-text-primary hover:text-accent-primary transition-colors inline-flex h-8 w-8 items-center justify-center" aria-label="Search site" title="Search">
            <SearchIcon size="1.25rem" />
          </a>
          <button
            id="theme-toggle-desktop"
            type="button"
            class="theme-toggle group relative inline-flex h-8 w-16 items-center rounded-full border-2 border-border bg-background-secondary transition-all hover:border-accent-primary focus:outline-none"
            aria-label="Switch to light theme"
          >
            <div class="absolute inset-0 z-20 pointer-events-none flex items-center">
              <span class="absolute left-[9px] top-1/2 -translate-y-1/2 text-text-muted/70">
                <SunIcon size="0.85rem" />
              </span>
              <span class="absolute right-[9px] top-1/2 -translate-y-1/2 text-text-muted/70">
                <MoonIcon size="0.85rem" />
              </span>
            </div>
            <span class="theme-toggle-thumb absolute left-1 top-[2px] h-6 w-6 rounded-full bg-white shadow-md transition-all duration-300 ease-in-out z-10"></span>
          </button>
        </div>
      </div>

      {/* Mobile Menu Toggle */}
      <button
        id="mobile-menu-button"
        class="lg:hidden relative z-[1100] p-2 -mr-2 text-text-primary hover:text-accent-primary transition-colors focus:outline-none"
        aria-label="Toggle menu"
        aria-expanded="false"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path id="menu-icon-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </nav>
  </div>

  {/* Mobile Menu Content - Starts directly below header, slides from LEFT */}
  <div
    id="mobile-menu"
    class="fixed left-0 w-full bg-background-primary z-[999] translate-x-[-100%] invisible transition-transform duration-300 ease-in-out lg:hidden flex flex-col"
    aria-hidden="true"
  >
    <div class="flex-1 overflow-y-auto px-6 py-8">
      <nav class="flex flex-col space-y-2 max-w-[500px] mx-auto">
        <a href="/writing" class="flex items-center justify-between py-6 border-b border-border/50 text-xl font-medium text-text-primary mobile-menu-link">
          <span>Writing</span>
          <svg class="w-5 h-5 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </a>
        <a href="/about" class="flex items-center justify-between py-6 border-b border-border/50 text-xl font-medium text-text-primary mobile-menu-link">
          <span>About</span>
          <svg class="w-5 h-5 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </a>
      </nav>

      <div class="mt-12 max-w-[500px] mx-auto space-y-6">
        <a href="/search" class="mobile-menu-link flex items-center justify-between p-5 bg-background-secondary rounded-2xl border border-border/50 w-full text-text-secondary hover:text-accent-primary transition-colors" aria-label="Search site">
          <div class="flex items-center gap-4">
            <SearchIcon size="1.5rem" />
            <span class="text-lg font-medium">Search site</span>
          </div>
        </a>

        <div class="flex items-center justify-between p-5 bg-background-secondary rounded-2xl border border-border/50">
          <span class="text-lg font-medium text-text-secondary">Appearance</span>
          <button
            id="theme-toggle-mobile"
            type="button"
            class="theme-toggle group relative inline-flex h-8 w-16 items-center rounded-full border-2 border-border bg-background-primary focus:outline-none"
          >
            <div class="absolute inset-0 z-20 pointer-events-none flex items-center">
              <span class="absolute left-[9px] top-1/2 -translate-y-1/2 text-text-muted/70">
                <SunIcon size="0.85rem" />
              </span>
              <span class="absolute right-[9px] top-1/2 -translate-y-1/2 text-text-muted/70">
                <MoonIcon size="0.85rem" />
              </span>
            </div>
            <span class="theme-toggle-thumb absolute left-1 top-[2px] h-6 w-6 rounded-full bg-white shadow-md transition-all duration-300 ease-in-out z-10"></span>
          </button>
        </div>
      </div>
    </div>
  </div>
</header>

<script is:inline>
  (() => {
    const updateThemeToggleState = (buttons, isLight, shouldAnimate = true) => {
      buttons.forEach((btn) => {
        btn.setAttribute('aria-pressed', String(isLight));
        const thumb = btn.querySelector('.theme-toggle-thumb');

        if (thumb) {
          if (!shouldAnimate) thumb.style.transition = 'none';
          const xOffset = isLight ? '0' : 'calc(2rem - 2px)';
          thumb.style.transform = `translateX(${xOffset})`;
          thumb.style.backgroundColor = isLight ? 'var(--color-border)' : '#ffffff';
          if (!shouldAnimate) { void thumb.offsetWidth; thumb.style.transition = ''; }
        }

      });
    };

    const getStoredThemePreference = () => {
      const stored = localStorage.getItem('theme');
      if (stored) return stored === 'light';
      return window.matchMedia('(prefers-color-scheme: light)').matches;
    };

    const applyThemeClass = (isLight) => document.documentElement.classList.toggle('theme-light', isLight);

    const setTheme = (buttons, isLight, options = {}) => {
      const { persist = true, animate = true } = options;
      applyThemeClass(isLight);
      if (persist) localStorage.setItem('theme', isLight ? 'light' : 'dark');
      updateThemeToggleState(buttons, isLight, animate);
    };

    const initHeaderInteractions = () => {
      const header = document.querySelector('[data-site-header]');
      if (!header || header.dataset.interactionsInitialized === 'true') return;
      header.dataset.interactionsInitialized = 'true';

      const menuButton = header.querySelector('#mobile-menu-button');
      const mobileMenu = document.getElementById('mobile-menu');

      if (mobileMenu && mobileMenu.dataset.portalized !== 'true') {
        // Keep fixed positioning anchored to the viewport even when the header is sticky.
        mobileMenu.dataset.portalized = 'true';
        document.body.appendChild(mobileMenu);
      }

      if (mobileMenu) {
        // Calculate real header height
        const headerHeight = header.offsetHeight || 64;
        mobileMenu.style.top = `${headerHeight}px`;
        mobileMenu.style.height = `calc(100vh - ${headerHeight}px)`;
      }

      if (menuButton && mobileMenu) {
        let lockedScrollY = 0;
        const lockScroll = () => {
          lockedScrollY = window.scrollY || window.pageYOffset || 0;
          document.documentElement.style.overflow = 'hidden';
          document.body.style.position = 'fixed';
          document.body.style.top = `-${lockedScrollY}px`;
          document.body.style.width = '100%';
        };
        const unlockScroll = () => {
          document.documentElement.style.overflow = '';
          document.body.style.position = '';
          document.body.style.top = '';
          document.body.style.width = '';
          window.scrollTo(0, lockedScrollY);
        };

        const toggleMenu = (open) => {
          const logoImg = header.querySelector('#site-logo-img');
          menuButton.setAttribute('aria-expanded', String(open));
          
          if (logoImg) {
            logoImg.style.transform = open ? 'rotate(360deg)' : 'rotate(0deg)';
          }

          if (open) {
            // Recalculate position on open
            const headerRect = header.getBoundingClientRect();
            mobileMenu.style.top = `${headerRect.bottom}px`;
            mobileMenu.style.height = `calc(100vh - ${headerRect.bottom}px)`;
            
            header.classList.add('is-menu-open');
            mobileMenu.classList.remove('translate-x-[-100%]', 'invisible');
            mobileMenu.classList.add('translate-x-0');
            lockScroll();
          } else {
            header.classList.remove('is-menu-open');
            mobileMenu.classList.remove('translate-x-0');
            mobileMenu.classList.add('translate-x-[-100%]');
            unlockScroll();
            setTimeout(() => {
              if (menuButton.getAttribute('aria-expanded') === 'false') mobileMenu.classList.add('invisible');
            }, 300);
          }

          const path = menuButton.querySelector('#menu-icon-path');
          if (path) {
            path.setAttribute('d', open ? 'M6 18L18 6M6 6l12 12' : 'M4 6h16M4 12h16M4 18h16');
          }
        };

        menuButton.addEventListener('click', () => toggleMenu(menuButton.getAttribute('aria-expanded') === 'false'));
        mobileMenu.querySelectorAll('.mobile-menu-link').forEach(link => link.addEventListener('click', () => toggleMenu(false)));
      }

      const themeToggleButtons = document.querySelectorAll('.theme-toggle');
      if (themeToggleButtons.length > 0) {
        setTheme(themeToggleButtons, getStoredThemePreference(), { persist: false, animate: false });
        themeToggleButtons.forEach(btn => btn.addEventListener('click', () => setTheme(themeToggleButtons, !document.documentElement.classList.contains('theme-light'))));
      }
    };

    const scheduleInit = () => window.requestAnimationFrame(initHeaderInteractions);
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', scheduleInit, { once: true });
    else scheduleInit();
    document.addEventListener('astro:page-load', scheduleInit);
  })();
</script>

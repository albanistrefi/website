---
import Layout from './Layout.astro';
import { Header, Footer } from '@/components';
import { formatDate, getReadingTimeMinutes } from '@/utils';
import type { CollectionEntry } from 'astro:content';
import { Fragment } from 'astro/jsx-runtime';

interface Props {
  post: CollectionEntry<'writing'>;
  headings?: { depth: number; slug: string; text: string }[];
}

const { post, headings = [] } = Astro.props;
const { title, description, publishDate, tags } = post.data;
const slug = post.slug;
const formattedDate = formatDate(publishDate);
const minutesRead = getReadingTimeMinutes(post.body);
const transitionId = `post-heading-${slug}`;
const updatedDate = post.data.updatedDate ?? publishDate;
const hasUpdatedDate = updatedDate.getTime() !== publishDate.getTime();
const formattedUpdatedDate = formatDate(updatedDate);

const site = Astro.site ?? new URL('https://www.albanistrefi.me');
const postUrl = new URL(`/writing/${slug}`, site).toString();
const imageUrl = post.data.image
  ? new URL(post.data.image, site).toString()
  : new URL('/og-image@2x.png', site).toString();
const authorName = post.data.author ?? 'Alban Istrefi';

const blogPostingSchema = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description,
  url: postUrl,
  inLanguage: 'en',
  datePublished: publishDate.toISOString(),
  dateModified: updatedDate.toISOString(),
  mainEntityOfPage: { '@type': 'WebPage', '@id': postUrl },
  author: { '@type': 'Person', name: authorName },
  publisher: { '@type': 'Person', name: authorName },
  image: imageUrl,
  ...(tags && tags.length > 0 ? { keywords: tags.join(', ') } : {}),
};

const markdownUrl = new URL(`/writing/${slug}.md`, site).toString();
---

<Layout title={`${title} - Alban Istrefi`} description={description}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(blogPostingSchema)} />
    <link rel="alternate" type="text/markdown" href={markdownUrl} title={`${title} (Markdown)`} />
  </Fragment>
  <Header />

  <main
    id="main-content"
    class="page-shell mx-auto max-w-[900px] py-12 lg:py-20"
  >
    <div class="grid grid-cols-1 lg:grid-cols-[15%_1fr] gap-8 lg:gap-12">
      
      {/* Title & Tags Area (Desktop: Right Column) */}
      <div class="lg:col-start-2">
        <h1
          class="text-3xl lg:text-4xl font-semibold leading-tight text-text-primary mb-4"
          transition:name={transitionId}
        >
          {title}
        </h1>

        {tags && tags.length > 0 && (
          <div class="flex flex-wrap gap-2 mb-8 lg:mb-12">
            {tags.map((tag: string) => (
              <span class="text-xs font-mono text-text-muted">#{tag}</span>
            ))}
          </div>
        )}
      </div>

      {/* Left Sidebar: Metadata (Desktop) */}
      <aside class="hidden lg:block">
        <div class="flex flex-col gap-6">
          <div class="flex flex-col gap-1 text-sm">
            <time datetime={publishDate.toISOString()} class="font-medium text-text-primary">{formattedDate}</time>
            <span class="text-text-tertiary">{minutesRead} min read</span>
          </div>

          <div class="h-px w-8 bg-border mt-2"></div>
          
          <a href="/writing" class="text-sm text-text-tertiary hover:text-accent-primary transition-colors">
            ← Back to writing
          </a>
        </div>
      </aside>

      {/* Middle: Article Content */}
      <article class="min-w-0">
        
        {/* Mobile Metadata */}
        <div class="lg:hidden mb-6 flex flex-wrap items-center gap-3 text-sm text-text-tertiary">
          <time datetime={publishDate.toISOString()}>{formattedDate}</time>
          <span>•</span>
          <span>{minutesRead} min read</span>
        </div>

        <div class="prose prose-invert max-w-none">
          <slot />
        </div>
        
        {/* Footer */}
        <div class="mt-12 pt-8 border-t border-border">
          <div class="flex flex-col gap-6">
            {hasUpdatedDate && (
              <p class="text-sm text-text-tertiary italic">
                Updated <time datetime={updatedDate.toISOString()}>{formattedUpdatedDate}</time>
              </p>
            )}
            <div>
              <a href="/writing" class="text-sm text-text-tertiary hover:text-accent-primary transition-colors">
                ← Back to writing
              </a>
            </div>
          </div>
        </div>
      </article>
    </div>
  </main>

  <Footer />
</Layout>

<style is:global>
  /* Prose styles for MDX content */
  .prose {
    color: var(--color-text);
  }

  .prose h1 {
    font-family: var(--font-heading);
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1.2;
    color: var(--color-text);
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  .prose h2 {
    font-family: var(--font-heading);
    font-size: 2rem;
    font-weight: 600;
    line-height: 1.3;
    color: var(--color-text);
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  .prose h3 {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    font-weight: 600;
    line-height: 1.4;
    color: var(--color-text);
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .prose h4 {
    font-family: var(--font-heading);
    font-size: 1.25rem;
    font-weight: 600;
    line-height: 1.4;
    color: var(--color-text);
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .prose p {
    font-family: var(--font-body);
    font-size: 1rem;
    line-height: 1.75;
    color: var(--color-text);
    margin-bottom: 1.5rem;
  }

  .prose a {
    color: var(--color-accent);
    text-decoration: underline;
    text-decoration-color: var(--color-accent-secondary);
    text-underline-offset: 2px;
    transition: all 0.2s ease-in-out;
  }

  .prose a:hover {
    color: var(--color-accent-hover);
    text-decoration-color: var(--color-accent-hover);
  }

  .prose strong {
    font-weight: 600;
    color: var(--color-text);
  }

  .prose em {
    font-style: italic;
  }

  .prose code {
    font-family: var(--font-code);
    font-size: 0.875rem;
    background-color: var(--color-background-secondary);
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    color: var(--color-accent);
  }

  .prose pre {
    font-family: var(--font-code);
    font-size: 0.875rem;
    line-height: 1.7;
    background-color: var(--color-background-secondary);
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-bottom: 1.5rem;
  }

  .prose pre code {
    background-color: transparent;
    padding: 0;
    font-size: inherit;
    color: var(--color-text);
  }

  .prose ul,
  .prose ol {
    margin-bottom: 1.5rem;
    padding-left: 1.5rem;
  }

  .prose ul {
    list-style-type: disc;
  }

  .prose ol {
    list-style-type: decimal;
  }

  .prose li {
    font-family: var(--font-body);
    font-size: 1rem;
    line-height: 1.75;
    color: var(--color-text);
    margin-bottom: 0.5rem;
  }

  .prose blockquote {
    border-left: 4px solid var(--color-text-muted);
    padding-left: 1rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: var(--color-text-primary);
    font-size: 1.5rem;
    line-height: 1.6;
  }

  .prose img {
    border-radius: 0.5rem;
    margin: 1.5rem 0;
    max-width: 100%;
    height: auto;
  }

  .prose hr {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: 2rem 0;
  }

  .prose table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1.5rem;
  }

  .prose th,
  .prose td {
    border: 1px solid var(--color-border);
    padding: 0.75rem;
    text-align: left;
  }

  .prose th {
    background-color: var(--color-background-secondary);
    font-weight: 600;
  }
</style>
